<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Weekly Notes</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600;700;800;900&display=swap" rel="stylesheet">

<style>
  *{ box-sizing:border-box; }

  :root{
    --bg:#ffffff;
    --ink:#1c1c1e;
    --muted:#8e8e93;
    --line: rgba(0,0,0,.06);
    --soft: rgba(0,0,0,.03);

    --p1: rgba(255, 231, 140, 1);
    --p2: rgba(142, 230, 178, 1);
    --p3: rgba(186, 170, 255, 1);
    --p4: rgba(255, 163, 191, 1);
    --p5: rgba(140, 205, 255, 1);

    --sidebar-w: 380px;
    --today-grey: rgba(0,0,0,.07);
  }

  html,body{
    height:100%;
    margin:0;
    font-family: "Noto Sans", -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", system-ui, sans-serif;
    background:var(--bg);
    color:var(--ink);
    overflow:hidden;
  }

  /* ‚úÖ remove browser focus outlines (blue border) */
  :focus { outline: none !important; }
  :focus-visible { outline: none !important; }
  .task *:focus { outline: none !important; }
  .idea-item *:focus { outline: none !important; }
  .navbtn:focus, .navbtn:focus-visible { outline:none !important; box-shadow:none !important; }

  .app{
    height:100vh;
    display:grid;
    grid-template-columns: var(--sidebar-w) 1fr;
    overflow:hidden;
  }

  .sidebar{
    border-right:1px solid var(--line);
    padding:16px 16px;
    display:flex;
    flex-direction:column;
    gap:12px;
    overflow:hidden;
    min-width: var(--sidebar-w);
  }

  .sidebar-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:10px;
  }
  .sidebar-header strong{
    font-size:20px;
    font-weight:900;
  }

  .navbtn{
    border:none;
    background:rgba(0,0,0,.04);
    font-size:18px;
    padding:6px 10px;
    cursor:pointer;
    color:var(--ink);
    border-radius:12px;
  }
  .navbtn:hover{ background:rgba(0,0,0,.06); }

  .dow,.calendar{
    display:grid;
    grid-template-columns:repeat(7,1fr);
    text-align:center;
  }
  .dow div{
    font-size:13px;
    color:var(--muted);
    padding:6px 0 8px;
    font-weight:700;
  }

  .day{
    padding:10px 0 8px;
    border-radius:12px;
    cursor:pointer;
    font-size:15px;
    font-weight:800;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:6px;
  }
  .day:hover{ background:rgba(0,0,0,.04); }
  .day.inactive{ color:#c7c7cc; }
  .day.today{ background: var(--today-grey); }

  .day.active{
    background: rgba(0,122,255,1) !important;
    color: #fff !important;
  }

  .dots{
    display:flex;
    gap:6px;
    height:10px;
    align-items:center;
    justify-content:center;
  }
  .dot{
    width:8px;
    height:8px;
    border-radius:999px;
    box-shadow: 0 1px 0 rgba(0,0,0,.15);
  }
  .day.active .dot{
    box-shadow: 0 0 0 1px rgba(255,255,255,.65);
  }

  /* Ideas */
  .ideas{
    flex:1 1 auto;
    min-height:0;
    display:flex;
    flex-direction:column;
    gap:10px;
    padding-top:6px;
    border-top:1px solid var(--line);
    overflow:hidden;
  }
  .ideas-title{ padding-top:8px; }
  .ideas-title h2{
    margin:0;
    font-size:18px;
    font-weight:900;
  }
  .idea-input input{
    width:100%;
    border:none;
    border-radius:12px;
    background:rgba(0,0,0,.04);
    padding:10px 10px;
    font-size:15px;
    outline:none;
    font-family: inherit;
  }
  .idea-list{
    flex:1 1 auto;
    min-height:0;
    overflow:auto;
    padding-right:4px;
  }

  .idea-item{
    position:relative;
    display:grid;
    grid-template-columns:18px 1fr;
    gap:10px;
    align-items:start;
    padding:9px 9px;
    border-radius:14px;
    cursor:default;
  }
  .idea-item:hover{ background:var(--soft); }

  .handle{
    width:18px;
    height:22px;
    line-height:22px;
    text-align:center;
    color:rgba(0,0,0,.25);
    user-select:none;
    cursor:grab;
    opacity:.85;
  }
  .idea-text{
    font-size:15px;
    line-height:1.35;
    white-space:pre-wrap;
    word-break:break-word;
    user-select:text;
  }

  /* Highlights */
  .hl1{ background: rgba(255, 248, 210, 1) !important; }
  .hl2{ background: rgba(206, 245, 219, 1) !important; }
  .hl3{ background: rgba(232, 227, 255, 1) !important; }
  .hl4{ background: rgba(255, 223, 233, 1) !important; }
  .hl5{ background: rgba(213, 238, 255, 1) !important; }

  /* Main */
  .main{
    padding:16px 16px;
    overflow:hidden;
    display:flex;
    flex-direction:column;
    min-width:0;
    gap:10px;
  }

  .titlebar{
    display:grid;
    grid-template-columns: 1fr auto 1fr;
    align-items:center;
    gap:10px;
  }
  .titlebar .left{ justify-self:start; }
  .titlebar .center{ justify-self:center; text-align:center; min-width:0; }
  .titlebar .right{ justify-self:end; }

  .week-title{
    font-size: clamp(16px, 2.0vw, 26px);
    font-weight:900;
    letter-spacing:.2px;
    margin:0;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .week-sub{
    font-size: clamp(12px, 1.2vw, 15px);
    color:var(--muted);
    margin:0;
    text-align:center;
  }

  .week{
    flex:1 1 auto;
    min-height:0;
    display:grid;
    grid-template-columns:repeat(6, minmax(0, 1fr));
    gap:0;
    overflow:hidden;
  }
  .day-col{
    padding:0 12px;
    position:relative;
    min-width:0;
  }
  .day-col:not(:last-child)::after{
    content:"";
    position:absolute;
    top:0;
    right:0;
    width:1px;
    height:100%;
    background:linear-gradient(to bottom, transparent, var(--line), transparent);
  }

  .day-name{
    display:flex;
    align-items:baseline;
    gap:8px;
    font-weight:900;
    font-size: clamp(12px, 1.35vw, 18px);
    margin:0 0 8px 0;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .day-date{
    font-size: clamp(10px, 1.0vw, 12px);
    color:var(--muted);
    font-weight:700;
  }

  .section{ margin-bottom:10px; }
  .section-emoji{ font-size: clamp(14px, 1.6vw, 18px); margin-bottom:6px; }

  .task{
    position: relative;
    display:grid;
    grid-template-columns:18px 1fr;
    gap:8px;
    align-items:start;
    padding:8px 8px;
    border-radius:14px;
    background:transparent;
    cursor:default;
  }
  .task:hover{ background:var(--soft); }

  .selected{ background: rgba(0,0,0,.06) !important; }

  .task:hover .task-handle{ opacity:1; }
  .task-handle{ opacity:0; transition:opacity .12s ease; }

  .task-body{
    font-size: clamp(12px, 1.15vw, 15px);
    line-height:1.45;
    white-space:pre-wrap;
    word-break:break-word;
    outline:none;
    min-height:2.1em;
    font-family: inherit;
    user-select:text;

    overflow:hidden;
    display:-webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
  }

  .task-x{
    position:absolute;
    top:6px;
    right:6px;
    width:20px;
    height:20px;
    border-radius:999px;
    border:none;
    background: rgba(0,0,0,.06);
    color: rgba(0,0,0,.45);
    font-size:15px;
    line-height:20px;
    padding:0;
    cursor:pointer;
    display:none;
  }
  .task:hover .task-x{ display:block; }
  .task-x:hover{ background: rgba(255,59,48,.14); color: rgba(255,59,48,1); }

  .editing{ background: rgba(0,0,0,.04) !important; }
  .editing .task-body{
    -webkit-line-clamp: unset;
    overflow: visible;
    display:block;
  }

  /* ‚úÖ remove keyboard focus ring styling (no blue outline) */
  .kbfocus{ outline:none !important; }

  .palette{
    position:fixed;
    z-index:9999;
    display:none;
    padding:10px 12px;
    border-radius:16px;
    background:rgba(255,255,255,.94);
    box-shadow:0 18px 48px rgba(0,0,0,.18);
    border:1px solid rgba(0,0,0,.06);
    backdrop-filter: blur(12px);
    gap:10px;
    align-items:center;
  }
  .swatch{
    width:18px;
    height:18px;
    border-radius:999px;
    border:1px solid rgba(0,0,0,.08);
    cursor:pointer;
  }
  .sw0{
    background: transparent;
    border: 1px dashed rgba(0,0,0,.22);
    position: relative;
  }
  .sw0::after{
    content:"";
    position:absolute;
    inset:4px;
    border-radius:999px;
    background: rgba(0,0,0,.05);
  }
  .sw1{ background: rgba(255, 248, 210, 1); }
  .sw2{ background: rgba(206, 245, 219, 1); }
  .sw3{ background: rgba(232, 227, 255, 1); }
  .sw4{ background: rgba(255, 223, 233, 1); }
  .sw5{ background: rgba(213, 238, 255, 1); }

  .dragging{ opacity:.55; }
  .drop-target{ background: rgba(0,0,0,.06) !important; }

  @media (max-width: 1100px){
    html,body{ overflow:auto; }
    .app{ height:auto; overflow:visible; grid-template-columns:1fr; }
    .sidebar{ border-right:none; border-bottom:1px solid var(--line); min-width:auto; }
    .main{ overflow:visible; }
    .week{ overflow:visible; grid-template-columns:1fr; }
    .day-col:not(:last-child)::after{ display:none; }
    .task-handle{ opacity:1; }
    .task-x{ display:block; }
  }
</style>
</head>

<body>
<div class="app">
  <aside class="sidebar">
    <div class="calendar-wrap">
      <div class="sidebar-header">
        <button class="navbtn" id="prevMonth" aria-label="Previous month">‚Äπ</button>
        <strong id="monthLabel"></strong>
        <button class="navbtn" id="nextMonth" aria-label="Next month">‚Ä∫</button>
      </div>

      <div class="dow" aria-hidden="true">
        <div>S</div><div>M</div><div>T</div>
        <div>W</div><div>T</div><div>F</div><div>S</div>
      </div>

      <div class="calendar" id="calendar"></div>
    </div>

    <section class="ideas" aria-label="Things ideas board">
      <div class="ideas-title">
        <h2>Thingsüí°</h2>
      </div>

      <div class="idea-input">
        <input id="ideaInput" type="text" aria-label="Add idea" />
      </div>

      <div class="idea-list" id="ideaList"></div>
    </section>
  </aside>

  <main class="main">
    <div class="titlebar">
      <div class="left">
        <button class="navbtn" id="prevWeek" aria-label="Previous week">‚Äπ</button>
      </div>

      <div class="center">
        <h1 class="week-title" id="weekTitle"></h1>
        <p class="week-sub" id="weekRange"></p>
      </div>

      <div class="right">
        <button class="navbtn" id="nextWeek" aria-label="Next week">‚Ä∫</button>
      </div>
    </div>

    <div class="week" id="week"></div>
  </main>
</div>

<div class="palette" id="palette" role="dialog" aria-label="Highlight colors">
  <div class="swatch sw0" data-hl="" title="None"></div>
  <div class="swatch sw1" data-hl="hl1" title="Highlight 1"></div>
  <div class="swatch sw2" data-hl="hl2" title="Highlight 2"></div>
  <div class="swatch sw3" data-hl="hl3" title="Highlight 3"></div>
  <div class="swatch sw4" data-hl="hl4" title="Highlight 4"></div>
  <div class="swatch sw5" data-hl="hl5" title="Highlight 5"></div>
</div>

<script>
  const KEY = "weekly_notes_no_blue_focus_v1";
  const store = safeParse(localStorage.getItem(KEY)) || { days:{}, ideas:[] };
  function safeParse(s){ try { return JSON.parse(s); } catch { return null; } }
  const save = () => localStorage.setItem(KEY, JSON.stringify(store));
  if(!store.days) store.days = {};
  if(!Array.isArray(store.ideas)) store.ideas = [];

  const SLOTS = 3;
  const PARTS = ["m","a","e"];
  const DAY_OFFSETS = [1,2,3,4,5,6]; // Mon..Sat

  function ensureDay(k){
    if(!store.days[k]) store.days[k] = { m:Array(SLOTS).fill(null), a:Array(SLOTS).fill(null), e:Array(SLOTS).fill(null) };
    for(const part of PARTS){
      if(!Array.isArray(store.days[k][part])) store.days[k][part] = Array(SLOTS).fill(null);
      store.days[k][part] = store.days[k][part].slice(0,SLOTS);
      while(store.days[k][part].length < SLOTS) store.days[k][part].push(null);
      store.days[k][part] = store.days[k][part].map(v => {
        if(!v) return null;
        if(typeof v === "string") return { t: v, hl: "" };
        return { t: v.t || "", hl: v.hl || "" };
      });
    }
  }

  const today = new Date(); today.setHours(0,0,0,0);
  let active = new Date(today);
  let viewMonth = new Date(today.getFullYear(), today.getMonth(), 1);

  const ymd = d => d.toISOString().slice(0,10);
  const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); x.setHours(0,0,0,0); return x; }
  const startOfWeek = d => { const x=new Date(d); x.setHours(0,0,0,0); x.setDate(x.getDate()-x.getDay()); return x; }
  const weekOfMonth = d => {
    const first = new Date(d.getFullYear(), d.getMonth(), 1);
    return Math.ceil((d.getDate() + first.getDay()) / 7);
  };
  const fmtMD = d => `${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")}`;
  const fmtShortDay = d => ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][d.getDay()];

  function hlToDotColor(hl){
    switch(hl){
      case "hl1": return "var(--p1)";
      case "hl2": return "var(--p2)";
      case "hl3": return "var(--p3)";
      case "hl4": return "var(--p4)";
      case "hl5": return "var(--p5)";
      default: return null;
    }
  }

  function htmlToPlain(html){
    const div = document.createElement("div");
    div.innerHTML = html || "";
    return (div.textContent || div.innerText || "").replace(/\u00A0/g," ");
  }

  function escapeHTML(str){
    return str.replace(/[&<>"']/g, (ch) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[ch]));
  }

  function insertTextAtCursor(text){
    const sel = window.getSelection();
    if(!sel || sel.rangeCount === 0) return;
    const range = sel.getRangeAt(0);
    range.deleteContents();
    const node = document.createTextNode(text);
    range.insertNode(node);
    range.setStartAfter(node);
    range.collapse(true);
    sel.removeAllRanges();
    sel.addRange(range);
  }

  function placeCaretAtEnd(el){
    const range = document.createRange();
    range.selectNodeContents(el);
    range.collapse(false);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
  }

  function slotHasTextOrColor(dayKey, part, idx){
    ensureDay(dayKey);
    const v = store.days[dayKey][part][idx];
    if(!v) return false;
    const txt = htmlToPlain(v.t || "").trim();
    return !!txt || !!v.hl;
  }

  function dayHasAnything(dayKey){
    for(const p of PARTS){
      for(let i=0;i<SLOTS;i++){
        if(slotHasTextOrColor(dayKey,p,i)) return true;
      }
    }
    return false;
  }

  /* ===== Selection ===== */
  let selected = null; // {type:"task", el} OR {type:"idea", el, ideaId}
  function clearSelection(){
    document.querySelectorAll(".selected").forEach(el => el.classList.remove("selected"));
    selected = null;
  }
  function selectEl(obj){
    clearSelection();
    selected = obj;
    if(obj?.el) obj.el.classList.add("selected");
  }

  function isTypingContext(){
    const ae = document.activeElement;
    if(!ae) return false;
    if(ae.tagName === "INPUT" || ae.tagName === "TEXTAREA") return true;
    if(ae.isContentEditable) return true;
    return false;
  }

  /* ===== Arrow key navigation (no focus ring) ===== */
  const DAY_OFFSETS_ARR = [1,2,3,4,5,6];

  function getWeekDayKeys(){
    const start = startOfWeek(active);
    return DAY_OFFSETS_ARR.map(off => ymd(addDays(start, off)));
  }

  function getTaskElByMeta(dayKey, part, idx){
    return document.querySelector(`.task[data-day-key="${dayKey}"][data-part="${part}"][data-idx="${idx}"]`);
  }

  function taskIndexInDay(part, idx){
    const partBase = (part === "m") ? 0 : (part === "a") ? 3 : 6;
    return partBase + idx;
  }

  function indexToPartIdx(n){
    if(n <= 2) return { part:"m", idx:n };
    if(n <= 5) return { part:"a", idx:n-3 };
    return { part:"e", idx:n-6 };
  }

  function moveFocusByArrows(key){
    if(!selected || selected.type !== "task"){
      const weekKeys = getWeekDayKeys();
      const el = getTaskElByMeta(weekKeys[0], "m", 0);
      if(el) selectEl({ type:"task", el });
      return;
    }

    const curEl = selected.el;
    const meta = { dayKey: curEl.dataset.dayKey, part: curEl.dataset.part, idx: Number(curEl.dataset.idx) };
    const weekKeys = getWeekDayKeys();
    const dayIdx = weekKeys.indexOf(meta.dayKey);
    const slotIdx = taskIndexInDay(meta.part, meta.idx);

    let nextDayIdx = dayIdx;
    let nextSlotIdx = slotIdx;

    if(key === "ArrowLeft") nextDayIdx = Math.max(0, dayIdx - 1);
    if(key === "ArrowRight") nextDayIdx = Math.min(weekKeys.length - 1, dayIdx + 1);
    if(key === "ArrowUp") nextSlotIdx = Math.max(0, slotIdx - 1);
    if(key === "ArrowDown") nextSlotIdx = Math.min(8, slotIdx + 1);

    const { part, idx } = indexToPartIdx(nextSlotIdx);
    const nextEl = getTaskElByMeta(weekKeys[nextDayIdx], part, idx);
    if(nextEl){
      selectEl({ type:"task", el: nextEl });
      nextEl.scrollIntoView({ block:"nearest", inline:"nearest" });
    }
  }

  function enterEditMode(task){
    document.querySelectorAll(".task.editing").forEach(t => exitEditMode(t));
    hidePalette();
    task.classList.add("editing");
    const body = task.querySelector(".task-body");
    body.contentEditable = "true";
    body.focus();
    placeCaretAtEnd(body);
  }

  function exitEditMode(task){
    if(!task.classList.contains("editing")) return;
    const body = task.querySelector(".task-body");
    body.contentEditable = "false";
    task.classList.remove("editing");
  }

  document.addEventListener("keydown", (e) => {
    if(isTypingContext()) return;

    const keys = ["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"];
    if(keys.includes(e.key)){
      e.preventDefault();
      moveFocusByArrows(e.key);
      return;
    }

    if(e.key === "Enter" && selected && selected.type === "task"){
      e.preventDefault();
      enterEditMode(selected.el);
      return;
    }
  });

  /* delete selected */
  document.addEventListener("keydown", (e) => {
    if((e.key === "Delete" || e.key === "Backspace") && !isTypingContext() && selected){
      e.preventDefault();
      if(selected.type === "task"){
        const task = selected.el;
        if(task.classList.contains("editing")) return;
        clearTask(task);
        clearSelection();
        hidePalette();
      } else if(selected.type === "idea"){
        removeIdea(selected.ideaId);
        clearSelection();
        hidePalette();
      }
    }
  });

  /* click empty clears selection */
  document.addEventListener("mousedown", (e) => {
    const isTask = e.target.closest && e.target.closest(".task");
    const isIdea = e.target.closest && e.target.closest(".idea-item");
    const isPalette = palette.contains(e.target);
    const isHandle = e.target.closest && (e.target.closest(".task-handle") || e.target.closest(".idea-item .handle"));
    const isX = e.target.closest && e.target.closest(".task-x");
    if(isPalette || isHandle || isX) return;
    if(!isTask && !isIdea) clearSelection();
  });

  /* ===== Copy / Paste with color ===== */
  async function writeClipboardPayload(payload){
    const txt = JSON.stringify(payload);
    try{
      await navigator.clipboard.writeText(txt);
    }catch{
      const ta = document.createElement("textarea");
      ta.value = txt;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
    }
  }

  async function readClipboardPayload(){
    let txt = "";
    try{
      txt = await navigator.clipboard.readText();
    }catch{
      return null;
    }
    if(!txt) return null;

    if(txt.trim().startsWith("{") && txt.includes('"hl"') && txt.includes('"text"')){
      try{ return JSON.parse(txt); }catch{ }
    }
    return { kind:"plain", text: txt, hl:"" };
  }

  document.addEventListener("keydown", async (e) => {
    const mod = e.metaKey || e.ctrlKey;
    if(!mod) return;

    if(e.key.toLowerCase() === "c"){
      if(isTypingContext()) return;
      if(!selected) return;
      e.preventDefault();

      if(selected.type === "task"){
        const p = getTaskPayload(selected.el) || { t:"", hl:"" };
        const text = htmlToPlain(p.t || "").trim();
        if(!text && !p.hl) return;
        await writeClipboardPayload({ kind:"task", text, hl: p.hl || "" });
        return;
      }

      if(selected.type === "idea"){
        const idea = getIdeaById(selected.ideaId);
        if(!idea) return;
        const text = (idea.text || "").trim();
        if(!text && !idea.hl) return;
        await writeClipboardPayload({ kind:"idea", text, hl: idea.hl || "" });
        return;
      }
    }

    if(e.key.toLowerCase() === "v"){
      if(isTypingContext()) return;
      if(!selected) return;

      const payload = await readClipboardPayload();
      if(!payload || !payload.text) return;

      e.preventDefault();
      const clipText = String(payload.text || "");
      const clipHL = String(payload.hl || "");

      if(selected.type === "task"){
        const task = selected.el;
        const cur = getTaskPayload(task) || { t:"", hl:"" };
        const insert = escapeHTML(clipText).replace(/\n/g,"<br>");
        const nextText = (cur.t && htmlToPlain(cur.t).trim()) ? (cur.t + "<br>" + insert) : insert;
        const nextHL = cur.hl || clipHL || "";
        storeWriteTask(task, nextText, nextHL);
        renderWeek();
        renderCalendar();
        return;
      }

      if(selected.type === "idea"){
        addIdea(clipText, clipHL);
        return;
      }
    }
  });

  /* ===== Calendar ===== */
  const calendar = document.getElementById("calendar");
  const monthLabel = document.getElementById("monthLabel");

  function renderCalendar(){
    calendar.innerHTML = "";
    monthLabel.textContent = viewMonth.toLocaleDateString(undefined,{month:"long",year:"numeric"});
    const start = startOfWeek(new Date(viewMonth));

    for(let i=0;i<42;i++){
      const d = addDays(start,i);
      const key = ymd(d);
      ensureDay(key);

      const div = document.createElement("div");
      div.className = "day";

      const num = document.createElement("div");
      num.textContent = d.getDate();
      div.appendChild(num);

      if(dayHasAnything(key)){
        const dots = document.createElement("div");
        dots.className = "dots";

        const mkDot = (part)=>{
          if(!slotHasTextOrColor(key, part, 0)) return null;
          const c = hlToDotColor(store.days[key][part][0]?.hl || "");
          if(!c) return null;
          const dot = document.createElement("div");
          dot.className = "dot";
          dot.style.background = c;
          return dot;
        };

        const d1 = mkDot("m");
        const d2 = mkDot("a");
        const d3 = mkDot("e");
        if(d1) dots.appendChild(d1);
        if(d2) dots.appendChild(d2);
        if(d3) dots.appendChild(d3);
        if(dots.childElementCount > 0) div.appendChild(dots);
      }

      if(d.getMonth()!==viewMonth.getMonth()) div.classList.add("inactive");
      if(key===ymd(today)) div.classList.add("today");
      if(key===ymd(active)) div.classList.add("active");

      div.onclick = ()=>{ active=new Date(d); renderCalendar(); renderWeek(); hidePalette(); clearSelection(); };
      calendar.appendChild(div);
    }
  }

  /* ===== Ideas ===== */
  const ideaInput = document.getElementById("ideaInput");
  const ideaList = document.getElementById("ideaList");

  function newId(){
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function getIdeaById(id){
    return store.ideas.find(x => x.id === id);
  }

  function addIdea(text, hl=""){
    const t = (text || "").trim();
    if(!t) return;
    store.ideas.unshift({ id: newId(), text: t, hl: hl || "" });
    ideaInput.value = "";
    save();
    renderIdeas();
  }

  function removeIdea(id){
    store.ideas = store.ideas.filter(x => x.id !== id);
    save();
    renderIdeas();
  }

  function setIdeaHighlight(id, hl){
    const idea = store.ideas.find(x => x.id === id);
    if(!idea) return;
    idea.hl = hl || "";
    save();
    renderIdeas();
  }

  function renderIdeas(){
    ideaList.innerHTML = "";
    for(const idea of store.ideas){
      const item = document.createElement("div");
      item.className = "idea-item";
      if(idea.hl) item.classList.add(idea.hl);
      item.draggable = true;
      item.dataset.ideaId = idea.id;

      const handle = document.createElement("div");
      handle.className = "handle";
      handle.textContent = "‚ãÆ‚ãÆ";
      item.appendChild(handle);

      const text = document.createElement("div");
      text.className = "idea-text";
      text.textContent = idea.text;
      item.appendChild(text);

      item.addEventListener("mousedown", (e)=>{
        if(e.target.closest(".handle")) return;
        selectEl({ type:"idea", el:item, ideaId: idea.id });
      });

      item.addEventListener("dblclick", () => { removeIdea(idea.id); clearSelection(); });

      handle.addEventListener("mousedown", (e)=>e.preventDefault());
      handle.addEventListener("click", (e)=>{
        e.stopPropagation();
        selectEl({ type:"idea", el:item, ideaId: idea.id });
        setActiveTarget({ type:"idea", ideaId: idea.id, el: item });
        showPaletteNear(item);
      });

      item.addEventListener("dragstart", (e) => {
        item.classList.add("dragging");
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", JSON.stringify({ type:"idea", ideaId: idea.id }));
      });
      item.addEventListener("dragend", () => {
        item.classList.remove("dragging");
        document.querySelectorAll(".drop-target").forEach(el => el.classList.remove("drop-target"));
      });

      ideaList.appendChild(item);
    }

    ideaList.ondragover = (e)=>{ e.preventDefault(); };
    ideaList.ondrop = (e)=>{
      e.preventDefault();
      hidePalette();
      let payloadDrag;
      try { payloadDrag = JSON.parse(e.dataTransfer.getData("text/plain")); }
      catch { return; }
      if(payloadDrag.type !== "task") return;

      const from = payloadDrag.from;
      ensureDay(from.dayKey);
      const src = store.days[from.dayKey][from.part][from.idx];
      if(!src) return;

      const plain = htmlToPlain(src.t || "").trim();
      if(plain){
        store.ideas.unshift({ id: newId(), text: plain, hl: src.hl || "" });
      }
      store.days[from.dayKey][from.part][from.idx] = null;

      save();
      renderIdeas();
      renderWeek();
      renderCalendar();
    };
  }

  let ideaComposing = false;
  ideaInput.addEventListener("compositionstart", () => { ideaComposing = true; });
  ideaInput.addEventListener("compositionend", () => { ideaComposing = false; });
  ideaInput.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){
      if (ideaComposing || e.isComposing) return;
      e.preventDefault();
      addIdea(ideaInput.value);
    }
  });

  /* ===== Week render ===== */
  const weekEl = document.getElementById("week");
  const weekTitle = document.getElementById("weekTitle");
  const weekRange = document.getElementById("weekRange");

  function getTaskPayload(task){
    const dayKey = task.dataset.dayKey;
    const part = task.dataset.part;
    const idx = Number(task.dataset.idx);
    ensureDay(dayKey);
    return store.days[dayKey][part][idx];
  }

  function storeWriteTask(task, html, hl){
    const dayKey = task.dataset.dayKey;
    const part = task.dataset.part;
    const idx = Number(task.dataset.idx);
    ensureDay(dayKey);
    store.days[dayKey][part][idx] = { t: html, hl: hl || "" };
    save();
  }

  function writeTaskText(task, html){
    const dayKey = task.dataset.dayKey;
    const part = task.dataset.part;
    const idx = Number(task.dataset.idx);
    ensureDay(dayKey);
    const cur = store.days[dayKey][part][idx] || { t:"", hl:"" };
    store.days[dayKey][part][idx] = { t: html, hl: cur.hl || "" };
    save();
  }

  function clearTask(task){
    const dayKey = task.dataset.dayKey;
    const part = task.dataset.part;
    const idx = Number(task.dataset.idx);
    ensureDay(dayKey);
    store.days[dayKey][part][idx] = null;
    save();
    renderWeek();
    renderCalendar();
  }

  function renderWeek(){
    weekEl.innerHTML = "";
    const start = startOfWeek(active);
    const monday = addDays(start, 1);
    const saturday = addDays(start, 6);

    weekTitle.textContent = `${active.toLocaleDateString(undefined,{month:"long"})}, Week ${weekOfMonth(active)}`;
    weekRange.textContent = `${monday.toLocaleDateString()} ‚Äì ${saturday.toLocaleDateString()}`;

    const sections = [["m","‚òÄÔ∏è"],["a","üå§"],["e","üåô"]];

    for(const off of DAY_OFFSETS){
      const d = addDays(start, off);
      const dayKey = ymd(d);
      ensureDay(dayKey);

      const col = document.createElement("div");
      col.className = "day-col";

      const name = document.createElement("div");
      name.className = "day-name";
      name.innerHTML = `<span>${fmtShortDay(d)}</span><span class="day-date">${fmtMD(d)}</span>`;
      col.appendChild(name);

      for(const [part, emoji] of sections){
        const sec = document.createElement("div");
        sec.className = "section";

        const icon = document.createElement("div");
        icon.className = "section-emoji";
        icon.textContent = emoji;
        sec.appendChild(icon);

        for(let slot=0; slot<SLOTS; slot++){
          const task = document.createElement("div");
          task.className = "task";
          task.draggable = true;
          task.dataset.dayKey = dayKey;
          task.dataset.part = part;
          task.dataset.idx = String(slot);

          const payload = store.days[dayKey][part][slot];
          if(payload && payload.hl) task.classList.add(payload.hl);

          const handle = document.createElement("div");
          handle.className = "handle task-handle";
          handle.textContent = "‚ãÆ‚ãÆ";
          task.appendChild(handle);

          const body = document.createElement("div");
          body.className = "task-body";
          body.contentEditable = "false";
          body.spellcheck = true;
          body.innerHTML = payload ? (payload.t || "") : "";
          task.appendChild(body);

          let composing = false;
          body.addEventListener("compositionstart", ()=>{ composing = true; });
          body.addEventListener("compositionend", ()=>{ composing = false; });

          task.addEventListener("mousedown", (e)=>{
            if(e.target.closest(".task-handle") || e.target.closest(".task-x")) return;
            selectEl({ type:"task", el: task });
          });

          const xbtn = document.createElement("button");
          xbtn.className = "task-x";
          xbtn.type = "button";
          xbtn.textContent = "√ó";
          xbtn.title = "Remove";
          xbtn.addEventListener("mousedown", (e) => e.preventDefault());
          xbtn.addEventListener("click", (e) => {
            e.stopPropagation();
            clearTask(task);
            clearSelection();
            hidePalette();
          });
          task.appendChild(xbtn);

          handle.addEventListener("mousedown", (e) => e.preventDefault());
          handle.addEventListener("click", (e) => {
            e.stopPropagation();
            if(task.classList.contains("editing")) return;
            selectEl({ type:"task", el: task });
            setActiveTarget({ type:"task", taskEl: task });
            showPaletteNear(task);
          });

          task.addEventListener("dblclick", (e) => {
            e.preventDefault();
            selectEl({ type:"task", el: task });
            setActiveTarget({ type:"task", taskEl: task });
            enterEditMode(task);
          });

          body.addEventListener("input", () => {
            if(body.contentEditable !== "true") return;
            writeTaskText(task, body.innerHTML);
            renderCalendar();
          });

          body.addEventListener("paste", (e) => {
            if(body.contentEditable !== "true") return;
            e.preventDefault();
            const text = (e.clipboardData || window.clipboardData).getData("text/plain");
            insertTextAtCursor(text);
            writeTaskText(task, body.innerHTML);
            renderCalendar();
          });

          body.addEventListener("blur", () => exitEditMode(task));

          body.addEventListener("keydown", (e) => {
            if(e.key === "Tab"){
              if(composing || e.isComposing) return;
              e.preventDefault();
              exitEditMode(task);
              selectEl({ type:"task", el: task });
              moveFocusByArrows(e.shiftKey ? "ArrowUp" : "ArrowDown");
              if(selected && selected.type === "task") enterEditMode(selected.el);
              return;
            }
            if(e.key === "Escape"){
              e.preventDefault();
              body.blur();
            }
          });

          task.addEventListener("dragover", (e) => {
            e.preventDefault();
            task.classList.add("drop-target");
            e.dataTransfer.dropEffect = "move";
          });
          task.addEventListener("dragleave", () => task.classList.remove("drop-target"));

          task.addEventListener("drop", (e) => {
            e.preventDefault();
            task.classList.remove("drop-target");
            hidePalette();

            let payloadDrag;
            try { payloadDrag = JSON.parse(e.dataTransfer.getData("text/plain")); }
            catch { return; }

            const to = { dayKey: task.dataset.dayKey, part: task.dataset.part, idx: Number(task.dataset.idx) };
            ensureDay(to.dayKey);

            if(payloadDrag.type === "task"){
              const from = payloadDrag.from;
              if(from.dayKey === to.dayKey && from.part === to.part && from.idx === to.idx) return;
              ensureDay(from.dayKey);

              const src = store.days[from.dayKey][from.part][from.idx];
              const dst = store.days[to.dayKey][to.part][to.idx];

              store.days[from.dayKey][from.part][from.idx] = dst || null;
              store.days[to.dayKey][to.part][to.idx] = src || null;

              save();
              renderWeek();
              renderCalendar();
              return;
            }

            if(payloadDrag.type === "idea"){
              const idea = store.ideas.find(x => x.id === payloadDrag.ideaId);
              if(!idea) return;

              const current = store.days[to.dayKey][to.part][to.idx];
              const insert = escapeHTML(idea.text).replace(/\n/g, "<br>");
              const nextText = current && current.t && htmlToPlain(current.t).trim()
                ? (current.t + "<br>" + insert)
                : insert;

              const keepHL = (current?.hl || "") || (idea.hl || "");
              store.days[to.dayKey][to.part][to.idx] = { t: nextText, hl: keepHL };
              store.ideas = store.ideas.filter(x => x.id !== payloadDrag.ideaId);

              save();
              renderIdeas();
              renderWeek();
              renderCalendar();
              return;
            }
          });

          task.addEventListener("dragstart", (e) => {
            if(task.classList.contains("editing")) { e.preventDefault(); return; }
            const sel = window.getSelection();
            if(sel && !sel.isCollapsed) { e.preventDefault(); return; }
            hidePalette();
            task.classList.add("dragging");
            e.dataTransfer.effectAllowed = "move";
            e.dataTransfer.setData("text/plain", JSON.stringify({
              type: "task",
              from: { dayKey: task.dataset.dayKey, part: task.dataset.part, idx: Number(task.dataset.idx) }
            }));
          });

          task.addEventListener("dragend", () => {
            task.classList.remove("dragging");
            document.querySelectorAll(".drop-target").forEach(el => el.classList.remove("drop-target"));
          });

          sec.appendChild(task);
        }

        col.appendChild(sec);
      }

      weekEl.appendChild(col);
    }
    save();
  }

  /* ===== Palette ===== */
  const palette = document.getElementById("palette");
  let activeTarget = null;

  function setActiveTarget(t){ activeTarget = t; }
  function showPaletteNear(el){
    const rect = el.getBoundingClientRect();
    const pad = 10, palW = 210;
    const left = Math.min(Math.max(rect.left + rect.width/2 - palW/2, pad), window.innerWidth - palW - pad);
    const top = Math.max(rect.top - 54, pad);
    palette.style.left = `${left}px`;
    palette.style.top = `${top}px`;
    palette.style.display = "flex";
  }
  function hidePalette(){ palette.style.display = "none"; activeTarget = null; }

  document.querySelectorAll("#palette .swatch").forEach(sw => {
    sw.addEventListener("mousedown", (e) => e.preventDefault());
    sw.addEventListener("click", () => {
      if(!activeTarget) return;
      const hl = sw.dataset.hl || "";
      if(activeTarget.type === "task"){
        const task = activeTarget.taskEl;
        task.classList.remove("hl1","hl2","hl3","hl4","hl5");
        if(hl) task.classList.add(hl);
        storeWriteTask(task, (getTaskPayload(task)?.t || ""), hl);
        renderCalendar();
      } else if(activeTarget.type === "idea"){
        setIdeaHighlight(activeTarget.ideaId, hl);
      }
      hidePalette();
      renderCalendar();
    });
  });

  document.addEventListener("mousedown", (e) => {
    if(palette.contains(e.target)) return;
    if(e.target.closest && (e.target.closest(".task-handle") || e.target.closest(".idea-item .handle"))) return;
    hidePalette();
  });

  /* ===== Nav ===== */
  document.getElementById("prevMonth").onclick = () => { viewMonth.setMonth(viewMonth.getMonth()-1); renderCalendar(); };
  document.getElementById("nextMonth").onclick = () => { viewMonth.setMonth(viewMonth.getMonth()+1); renderCalendar(); };

  document.getElementById("prevWeek").onclick = () => {
    active = addDays(active, -7);
    viewMonth = new Date(active.getFullYear(), active.getMonth(), 1);
    renderCalendar(); renderWeek(); hidePalette(); clearSelection();
  };
  document.getElementById("nextWeek").onclick = () => {
    active = addDays(active, +7);
    viewMonth = new Date(active.getFullYear(), active.getMonth(), 1);
    renderCalendar(); renderWeek(); hidePalette(); clearSelection();
  };

  /* ===== Init ===== */
  renderCalendar();
  renderIdeas();
  renderWeek();
</script>
</body>
</html>
